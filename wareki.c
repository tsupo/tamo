/*
 *	wareki.c
 *			by H.Tsujimura	tsupo@na.rim.or.jp
 *						17 February 1991
 *	Copyright (c) 1991-1995,1996,1999	Hiroshi Tsujimura
 *	All Rights Reserved.
 *
 * History :
 * $Log: wareki.c $
 * Revision 1.72  2003/03/19  04:46:08  tsujimura543
 * ±x‚Μo—Ν•ϋ®‚π‘Ό‚Μ—ο‚Ζ“―‚¶‚Ι‚·‚ι
 *
 * Revision 1.71  2003/03/19  03:05:48  tsujimura543
 * ‹—οΦW‚Μo—Ν•ϋ–@‚π‘Ό‚Μ—ο‚Ζ“―‚¶•ϋ®‚Ι‚·‚ι
 *
 * Revision 1.70  2003/03/18  10:20:50  tsujimura543
 * o—Ν‹‰Κ‚‚«‚κ‚Ά‚Ι‚Θ‚ι‚ζ‚¤‚Ι’²®
 *
 * Revision 1.69  2003/03/17  05:44:54  tsujimura543
 * HTMLo—Ν“ΰ—e‚π®—
 *
 * Revision 1.68  2003/03/11  02:07:11  tsujimura543
 * for Tsuporone's Activity Memo
 *
 * Revision 1.67  2003/03/06  10:27:39  tsujimura543
 * ‰A“ΩJn“ϊ‚Μ‹γ―‚1‚Β‚Έ‚κ‚ι•s‹ο‡‚πC³
 *
 * Revision 1.66  2003/03/06  08:50:26  tsujimura543
 * ‹γ―‚ΜZo•ϋ–@‚π•ΟX
 *
 * Revision 1.65  2003/02/27  10:07:05  tsujimura543
 * ‘ε‰»Θ‘O‚ΝA“Vc‚Μ–Ό‘O‚Ε”N‘γ‚π•\‚·‚ζ‚¤‚Ι‚µ‚½
 *
 * Revision 1.64  2003/02/27  08:41:01  tsujimura543
 * ‘ε‰»Θ~‚Μ³†‚Ι‘Ξ‰
 *
 * Revision 1.63  2003/02/26  09:28:53  tsujimura543
 * cδΘ‘O‚Μ³†‚Ι‘Ξ‰(‚Ζ‚θ‚ ‚¦‚ΈAc’·‚ά‚Ε‘Ξ‰)
 *
 * Revision 1.62  2003/02/19  08:50:49  tsujimura543
 * ƒ†ƒƒEƒX“ϊ‚•‰‚Μ’l‚Μ‚Ζ‚«‚Ι—j“ϊζ“ΎΦ”‚λ“®μ‚·‚ι•s‹ο‡‚πC³
 *
 * Revision 1.61  2003/02/07  04:46:41  tsujimura543
 * a—ο‚Μ–Ό‚π•Ή‹L‚·‚ι‚ζ‚¤‚Ι‚µ‚½
 *
 * Revision 1.60  2001/02/20  12:23:36  tsujimura543
 * ‘Ό‚Μ”h¶ƒo[ƒWƒ‡ƒ“‚Ζ“‡‚·‚ι‚½‚ίA‚Ά‚Α‚½‚ρ revision ‚πΕ’θ
 *
 * Revision 1.51  1999/07/06  18:48:12  tsujimura543
 * J”­Β‹«‚π Win32 ‚ΙΪ‚·
 * -- HTML o—Ν‘Ξ‰μ‹Ζ‚β“®μm”F‚Ν΅γ‚ΰUNIX (peach.na.rim.or.jp) γ‚Εs‚Θ‚¤
 *
 * Revision 1.50  1996/08/19  02:10:16  tsujimura
 * Withdrawal from `shizuka' (UNIXγ‚Ε‚ΜJ”­I—Ή”Ε)
 *
 * Revision 1.6  95/12/16 05:55:16  tsujimura
 * ‚ΰ‚Ν‚β•s—v‚Ζ‚Θ‚Α‚½u’v‚Μ–ΌΜ‚Μƒe[ƒuƒ‹‚πν
 * 
 * Revision 1.5  92/03/29 16:24:14  tsujimura
 * test release
 * 
 * Revision 1.4  91/03/17 16:16:28  tsujimura
 * test version
 * 
 * Revision 1.3  91/03/17 16:16:28  tsujimura
 * (1) changed functions for calculations of old-japanese-calendar
 * (2) added some ETO holidays
 * 
 * Revision 1.2  91/03/02 05:29:46  tsujimura
 * added many features
 * 
 * Revision 1.1  91/02/17 10:58:18  tsujimura
 * Initial revision
 * 
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "dates.h"

#ifndef	lint
static char	*rcs_id =
	"$Header: E:/user/local/src/tamo/RCS/wareki.c 1.72 2003/03/19 04:46:08 tsujimura543 Exp tsujimura543 $";
#endif

#if 0
static char *gengo[]         = { "•¶‹v","³΅","cδ","–Ύ΅","‘ε³","Ίa","•½¬",0 };
static int  gengo_start_yy[] = { 1861,  1864,  1865,  1868,  1912,  1926,  1989 };
static int  gengo_start_mm[] = {  2,     2,     4,     9,     7,    12,     1 };
static int  gengo_start_dd[] = { 19,    20,     7,     8,    30,    25,     8 };
#else
static struct GENGO_TBL {
    char    *name;      /* –ΌΜ    */
    int     start_yy;   /* Jn ”N */
    int     start_mm;   /*       */
    int     start_dd;   /*      “ϊ */
}   gengo_tbl[] =   {
    { "Ό—ο",      1,  1,  1 },

    { "(‰_)",  270,  1,  1 },
    { "(m“Ώ)",  313,  1,  3 },
    { "(—’†)",  400,  2,  1 },
    { "(”½³)",  406,  1,  2 },
    { "(ς‹±)",  412, 12,  1 },
    { "(ΐN)",  454,  1,  1 },
    { "(—Y—)",  457,  1,  1 },
    { "(΄”J)",  480,  1, 15 },
    { "(°@)",  485,  1,  1 },
    { "(m«)",  488,  1,  5 },
    { "(•—σ)",  499,  1,  1 },
    { "(p‘Μ)",  507,  2,  4 },
    { "(ΐΥ)",  534,  1,  1 },
    { "(‹X‰»)",  536,  1,  1 },
    { "(‹Τ–Ύ)",  540,  1,  1 },
    { "(•q’B)",  572,  4,  3 },
    { "(—p–Ύ)",  586,  1,  1 },
    { "(’s)",  588,  1,  1 },
    { "(„Γ)",  593,  1,  1 },
    { "(®–Ύ)",  629,  1,  4 },
    { "(c‹Ι)",  642,  1, 15 },

    { "‘ε‰»",    645,  6, 19 },
    { "”’θ³",    650,  2, 15 }, /* F“Ώ“Vc•φδγg‚ν‚Θ‚­‚Θ‚Α‚½ */
    { "(Δ–Ύ)",  655,  1,  3 },
    { "(“V’q)",  661,  7, 24 },
    { "(“V•)",  672,  1,  1 },
    { "ι’Ή",    686,  7, 20 }, /* “V•“Vc•φδγg‚ν‚Θ‚­‚Θ‚Α‚½ */
    { "(“)",  687,  1,  1 },
    { "(•¶•)",  697,  8,  1 },
    { "‘ε•σ",    701,  3, 21 },
    { "c‰_",    704,  5, 10 },
    { "a“Ί",    708,  1, 11 },
    { "—μ‹T",    715,  9,  2 },
    { "—{V",    717, 11, 17 },
    { "_‹T",    724,  2,  4 },
    { "“V•½",    729,  8,  5 },
    { "“V•½΄•σ",749,  4, 14 },
    { "“V•½•σ",749,  7,  2 },
    { "“V•½•σ",757,  8, 18 },
    { "“V•½_μ",765,  1,  7 },
    { "_μi‰_",767,  8, 16 },
    { "•σ‹T",    770, 10,  1 },
    { "“V‰",    781,  1,  1 },
    { "‰„—ο",    782,  8, 19 },
    { "‘ε“―",    806,  5, 18 },
    { "Om",    810,  9, 19 },
    { "“V’·",    824,  1,  5 },
    { "³a",    834,  1,  3 },
    { "‰ΓΛ",    848,  6, 13 },
    { "mυ",    851,  4, 28 },
    { "Δt",    854, 11, 30 },
    { "“Vΐ",    857,  2, 21 },
    { "’εΟ",    859,  4, 15 },
    { "³c",    877,  4, 16 },
    { "ma",    885,  2, 21 },
    { "°•½",    889,  4, 27 },
    { "Ή‘Χ",    898,  4, 26 },
    { "‰„μ",    901,  7, 15 },
    { "‰„’·",    923,  4, 11 /* ‰[4 */ },
    { "³•½",    931,  4, 26 },
    { "“Vc",    938,  5, 22 },
    { "“V—ο",    947,  4, 22 },
    { "“V“Ώ",    957, 10, 27 },
    { "‰a",    961,  2, 16 },
    { "N•Ϋ",    964,  7, 10 },
    { "ΐa",    968,  8, 15 },
    { "“V\",    970,  3, 25 },
    { "“V‰„",    973, 12, 20 },
    { "’ε³",    976,  7, 13 },
    { "“V³",    978, 11, 29 },
    { "‰iΟ",    983,  4, 15 },
    { "°a",    985,  4, 27 },
    { "‰i‰„",    987,  4,  5 },
    { "‰iβN",    989,  8,  8 },
    { "³—ο",    990, 11,  7 },
    { "’·“Ώ",    995,  2, 22 },
    { "’·•Ϋ",    999,  1, 13 },
    { "°O",   1004,  7, 20 },
    { "’·a",   1012, 12, 25 },
    { "°m",   1017,  4, 23 },
    { "΅ΐ",   1021,  2,  2 },
    { "–υ",   1024,  7, 13 },
    { "’·³",   1028,  7, 25 },
    { "’·—ο",   1037,  4, 21 },
    { "’·‹v",   1040, 11, 10 },
    { "°“Ώ",   1044, 11, 24 },
    { "‰i³",   1046,  4, 14 },   
    { "“Vμ",   1053,  1, 11 },
    { "N•½",   1058,  8, 29 },
    { "΅—ο",   1065,  8,  2 },
    { "‰„‹v",   1069,  4, 13 },
    { "³•Ϋ",   1074,  8, 23 },
    { "³—ο",   1077, 11, 17 },
    { "‰i•Ϋ",   1081,  2, 10 },
    { "‰“Ώ",   1084,  2,  7 },
    { "°΅",   1087,  4,  7 },
    { "‰Γ•Ϋ",   1094, 12, 15 },
    { "‰i’·",   1096, 12, 17 },
    { "³“Ώ",   1097, 11, 21 },
    { "Na",   1099,  8, 28 },
    { "’·΅",   1104,  2, 10 },
    { "‰Γ³",   1106,  4,  9 },
    { "“Vm",   1108,  8,  3 },
    { "“V‰i",   1110,  7, 13 },
    { "‰i‹v",   1113,  7, 13 },
    { "³‰i",   1118,  4,  3 },
    { "•Ϋΐ",   1120,  4, 10 },
    { "“V΅",   1124,  4,  3 },
    { "‘ε΅",   1126,  1, 22 },
    { "“V³",   1131,  1, 29 },
    { "’·³",   1132,  8, 11 },
    { "•Ϋ‰„",   1135,  4, 27 },
    { "‰i΅",   1141,  7, 10 },
    { "N΅",   1142,  4, 28 },
    { "“V—{",   1144,  2, 23 },
    { "‹vΐ",   1145,  7, 22 },
    { "m•½",   1151,  1, 26 },
    { "‹vυ",   1154, 10, 28 },
    { "•Ϋ³",   1156,  4, 27 },
    { "•½΅",   1159,  4, 20 },
    { "‰i—ο",   1160,  1, 10 },
    { "‰•Ϋ",   1161,  9,  4 },
    { "’·°",   1163,  3, 29 },
    { "‰i–",   1165,  6,  5 },
    { "mΐ",   1166,  8, 27 },
    { "‰Γ‰",   1169,  4,  8 },
    { "³ΐ",   1171,  4, 21 },
    { "ΐ³",   1175,  7, 28 },
    { "΅³",   1177,  8,  4 },
    { "—{a",   1181,  7, 14 },
    { "υ‰i",   1182,  5, 27 },
    { "³—ο",   1184,  4, 16 },
    { "•¶΅",   1185,  8, 14 },
    { "‹v",   1190,  4, 11 },
    { "³΅",   1199,  4, 27 },
    { "m",   1201,  2, 13 },
    { "³‹v",   1204,  2, 20 },
    { "‰i",   1206,  4, 27 },
    { "³³",   1207, 10, 25 },
    { "—ο",   1211,  3,  9 },
    { "•Ϋ",   1213, 12,  6 },
    { "³‹v",   1219,  4, 12 },
    { "’ε‰",   1222,  4, 13 },
    { "³m",   1224, 11, 20 },
    { "‰Γ\",   1225,  4, 20 },
    { "ΐ’ε",   1227, 12, 10 },
    { "°μ",   1229,  3,  5 },
    { "’ε‰i",   1232,  4,  2 },
    { "“V•",   1233,  4, 15 },
    { "•¶—ο",   1234, 11,  5 },
    { "‰Γ’υ",   1235,  9, 19 },
    { "—οm",   1238, 11, 23 },
    { "‰„‰",   1239,  2,  7 },
    { "m΅",   1240,  7, 16 },
    { "°³",   1243,  2, 26 },
    { "•σ΅",   1247,  2, 28 },
    { "’·",   1249,  3, 18 },
    { "N³",   1256, 10,  5 },
    { "³‰Γ",   1257,  3, 14 },
    { "³³",   1259,  3, 26 },
    { "•¶‰",   1260,  4, 13 },
    { "O’·",   1261,  2, 20 },
    { "•¶‰i",   1264,  2, 28 },
    { "΅",   1275,  4, 25 },
    { "Oΐ",   1278,  2, 29 },
    { "³‰",   1288,  4, 28 },
    { "‰im",   1293,  8,  5 },
    { "³ΐ",   1299,  4, 25 },
    { "£³",   1302, 11, 21 },
    { "‰Γ³",   1303,  8,  5 },
    { "“Ώ΅",   1306, 12, 14 },
    { "‰„c",   1308, 10,  9 },
    { "‰’·",   1311,  4, 28 },
    { "³a",   1312,  3, 20 },
    { "•¶•Ϋ",   1317,  2,  3 },
    { "³‰",   1319,  4, 28 },
    { "³‹",   1321,  2, 23 },
    { "³’†",   1324, 12,  9 },
    { "‰Γ—ο",   1326,  4, 26 },
    { "³“Ώ",   1329,  8, 29 },
   /* “μ–k’©•—τ */
    { "–Ύ“Ώ",   1390,  3, 26 }, /* 1393”N‰[105“ϊA“μ–k’©‡κ */
    { "‰‰i",   1394,  7,  5 },
    { "³’·",   1428,  4, 27 },
    { "‰i‹",   1429,  9,  5 },
    { "‰Γ‹g",   1441,  2, 17 },
    { "•¶ΐ",   1444,  2,  5 },
    { "•σ“Ώ",   1449,  7, 28 },
    { "‹“Ώ",   1452,  7, 25 },
    { "N³",   1455,  7, 25 },
    { "’·\",   1457,  9, 28 },
    { "°³",   1460, 12, 21 },
    { "•¶³",   1466,  2, 28 },
    { "‰m",   1467,  3,  5 },
    { "•¶–Ύ",   1469,  4, 28 },
    { "’·‹",   1487,  7, 20 },
    { "‰„“Ώ",   1489,  8, 21 },
    { "–Ύ‰",   1492,  7, 19 },
    { "•¶‹T",   1501,  2, 29 },
    { "‰i³",   1504,  2, 30 },
    { "‘ε‰i",   1521,  8, 23 },
    { "‹\",   1528,  8, 20 },
    { "“V•¶",   1532,  7, 29 },
    { "O΅",   1555, 10, 23 },
    { "‰i\",   1558,  2, 28 },
    { "³‹T",   1570,  4, 23 },
    { "“V³",   1573,  7, 28 },
    { "•¶\",   1592, 12,  8 },
    { "c’·",   1596, 10, 27 },
    { "³a",   1615,  7, 13 },
    { "°‰i",   1624,  2, 30 },
    { "³•Ϋ",   1644, 12, 16 },
    { "cΐ",   1648,  2, 15 },
    { "³δ",   1652,  9, 18 },
    { "–Ύ—ο",   1655,  4, 13 },
    { "δέ΅",   1658,  7, 23 },
    { "°•¶",   1661,  4, 25 },
    { "‰„›",   1673,  9, 21 },
    { "“Va",   1681,  9, 29 },
    { "’ε‹",   1684,  2, 21 },
    { "³\",   1688,  9, 30 },
    { "›‰i",   1704,  3, 13 },
    { "³“Ώ",   1711,  4, 25 },
    { "‹•Ϋ",   1716,  6, 22 },
    { "³•¶",   1736,  4, 28 },
    { "°•Ϋ",   1741,  2, 27 },
    { "‰„‹",   1744,  2, 21 },
    { "°‰„",   1748,  7, 12 },
    { "›—ο",   1751, 10, 27 },
    { "–Ύa",   1764,  6,  2 },
    { "ΐ‰i",   1772, 11, 16 },
    { "“V–Ύ",   1781,  4,  2 },
    { "°­",   1789,  1, 25 },
    { "‹a",   1801,  2,  5 },
    { "•¶‰»",   1804,  2, 11 },
    { "•¶­",   1818,  4, 22 },
    { "“V•Ϋ",   1830, 12, 10 },
    { "O‰»",   1844, 12,  2 },
    { "‰Γ‰i",   1848,  2, 28 },
    { "ΐ­",   1854, 11, 27 },
    { "δέ‰„",   1860,  3, 18 },
    { "•¶‹v",   1861,  2, 19 },
    { "³΅",   1864,  2, 20 },
    { "cδ",   1865,  4,  7 },
    { "–Ύ΅",   1868,  9,  8 },
    { "‘ε³",   1912,  7, 30 },
    { "Ίa",   1926, 12, 25 },
    { "•½¬",   1989,  1,  8 },
    { NULL,     9999, 12, 31 }
};
#define gengo(i)            gengo_tbl[i].name
#define gengo_start_yy(i)   gengo_tbl[i].start_yy
#define gengo_start_mm(i)   gengo_tbl[i].start_mm
#define gengo_start_dd(i)   gengo_tbl[i].start_dd

static struct GENGO_TBL southGengo[] =
{  /* s“μ’©t */
    { "³O",   1331,  8,  9 },
    { "•",   1334,  1, 29 },
    { "‰„³",   1336,  2, 29 },
    { "‹»‘",   1340,  4, 28 },
    { "³•½",   1346, 12,  8 },
    { "“Ώ",   1370,  7, 24 },
    { "•¶’†",   1372, 10,  4 },
    { "“Vφ",   1375,  5, 27 },
    { "Oa",   1381,  2, 10 },
    { "³’†",   1384,  4, 28 },
   /* ³’†9(1392)”N‰[105“ϊA–k’©Eγ¬Ό“Vc‚ΙχΚ(“μ–k’©‡κ) */
    { NULL,     1394,  7,  5 }
};

static struct GENGO_TBL northGengo[] =
{  /* s–k’©t */
    { "³“Ώ",   1329,  8, 29 },
    { "³c",   1332,  4, 28 },
   /* ³c2(1333)”N525“ϊ γ‘ην“Vc‚ΙχΚA³†”p~ */
    { "•",   1334,  1, 29 },
   /* •3(1336)”N815“ϊ –k’©Eυ–Ύ“Vc‘¦Κ */
    { "—ο‰",   1338,  8, 28 },
    { "N‰i",   1342,  4, 27 },
    { "’εa",   1345, 10, 21 },
    { "Ο‰",   1350,  2, 27 },
    { "•¶a",   1352,  9, 27 },
    { "‰„•¶",   1356,  3, 28 },
    { "Nΐ",   1361,  3, 29 },
    { "’ε΅",   1362,  9, 23 },
    { "‰ΐ",   1368,  2, 18 },
    { "‰ia",   1375,  2, 27 },
    { "N—ο",   1379,  3, 22 },
    { "‰i“Ώ",   1381,  2, 24 },
    { "“Ώ",   1384,  2, 27 },
    { "‰Γc",   1387,  8, 23 },
    { "N‰",   1389,  2,  9 },
    { "–Ύ“Ώ",   1390,  3, 26 },
    { NULL,     1394,  7,  5 }
};

#define sGengo(i)            southGengo[i].name
#define sGengo_start_yy(i)   southGengo[i].start_yy
#define sGengo_start_mm(i)   southGengo[i].start_mm
#define sGengo_start_dd(i)   southGengo[i].start_dd

#define nGengo(i)            northGengo[i].name
#define nGengo_start_yy(i)   northGengo[i].start_yy
#define nGengo_start_mm(i)   northGengo[i].start_mm
#define nGengo_start_dd(i)   northGengo[i].start_dd
#endif

static char	*hoshi[]         = { "‹γ‡", "””’", "µΤ", "Z”’", "ά‰©",
                                 "l—Ξ", "O•Ι", "“ρ•", "κ”’" };
static char	*kan[]           = { "b", "‰³",
                                 "•Έ", "’",
                                 "•θ", "Θ",
                                 "M", "h",
                                 "p", "α΅" };
static char	*kan_yomi[]      = { "‚«‚Μ‚¦",   "‚«‚Μ‚Ζ",
                                 "‚Π‚Μ‚¦",   "‚Π‚Μ‚Ζ",
                                 "‚Β‚Ώ‚Μ‚¦", "‚Β‚Ώ‚Μ‚Ζ",
                                 "‚©‚Μ‚¦",   "‚©‚Μ‚Ζ",
                                 "‚έ‚Γ‚Μ‚¦", "‚έ‚Γ‚Μ‚Ζ" };
static char	*shi[]           = { "q", "‰N", "“Π", "‰K", "’C", "–¤",
                                 "ί", "–Ά", "\", "“Ρ", "ϊ", "ε" };
static char	*shi_yomi[]      = { "‚Λ", "‚¤‚µ", "‚Ζ‚η", "‚¤", "‚½‚Β", "‚έ",
                                 "‚¤‚ά", "‚Π‚Β‚¶", "‚³‚ι", "‚Ζ‚θ", "‚Ά‚Κ",
                                 "‚ξ" };
static char	*yoh[]           = { "“ϊ", "", "‰Ξ", "…",
                                 "–Ψ", "‹ΰ", "“y" };
static char	*tsuki[]         = { "–r", "”@",   "–ν¶", "‰K",
                                 "H", "…–³", "•¶", "—t",
                                 "’·", "_–³", "‘", "t‘–" };
static char	*shuku[]         = { "p", "΄","‚Δ‚Ά","–[", "S", "”φ", "–¥",
                                 "“l", "‹", "—", "‹•", "λ", "Ί", "•Η",
                                 "υ", "K", "έ", "γ", "•L", "ζX", "Q",
                                 "δ", "‹S", "–φ", "―", "’£", "—ƒ", "ηf"};
static char	*choku[]         = { "‚½‚Β",   "‚Μ‚Ό‚­", "‚έ‚Β",   "‚½‚Ά‚η",
                                 "‚³‚Ύ‚ρ", "‚Ζ‚ι",   "‚β‚Τ‚ι", "‚ ‚β‚Τ",
                                 "‚Θ‚ι",   "‚¨‚³‚ρ", "‚Π‚η‚­", "‚Ζ‚Γ"   };
#ifdef  __STDC__
char    *wareki2( int d, int m, int y, int u );
#else
char    *wareki2();
#endif

char	*
wareki( d, m, y, u )
int d, m, y, u;
{
    static char	buf[32];
    int		i;

    if ( (y >= 1331) && (y <= 1392) ) {
        long    g      = absoluteFromGregorian( d,  m,    y );
        long    gStart = absoluteFromGregorian( 9,  8, 1331 );
        long    gEnd   = absoluteFromGregorian( 5, 10, 1392 );

        if ( (g >= gStart) && (g <= gEnd) ) {
            return ( wareki2( d, m, y, u ) );
        }
    }

    for ( i = 0; gengo(i); i++ ) {
        if ( y < gengo_start_yy(i) )
            break;
        if ( y == gengo_start_yy(i) ) {
            if ( m < gengo_start_mm(i) )
                break;
            else if ( m == gengo_start_mm(i) ) {
                if ( d < gengo_start_dd(i) )
                    break;
            }
        }
    }
    if ( --i < 0 ) {
        i++;
        y--;
    }
    y -= gengo_start_yy(i) - 1;

    if ( u )
        sprintf( buf, "%s%2d”N‰[%2d(%s)%2d“ϊ",
                 gengo(i), y, m, tsuki[(m + 11) % 12], d );
    else
        sprintf( buf, "%s%2d”N%2d(%s)%2d“ϊ",
                 gengo(i), y, m, tsuki[(m + 11) % 12], d );
    return ( buf );
}


char	*
tsupodate( day, month, year )
int	day, month, year;
{
    static char	buf[20];

    if ( ( month == 1 ) && ( day == 1 ) )
        sprintf( buf, "%4d”N    ³“ϊ", year );
    else if ( ( month == 12 ) && ( day == 31 ) )
        sprintf( buf, "%4d”N  ‘εA“ϊ", year );
    else if ( day == 1 )
        sprintf( buf, "%4d”N%sρ“ϊ", year, tsuki[month-1] );
    else if ( day == lastDayOfGregorianMonth( month, year ) )
        sprintf( buf, "%4d”N%sA“ϊ", year, tsuki[month-1] );
    else
        sprintf( buf, "%4d”N%s%2d“ϊ", year, tsuki[month-1], day );
    if ( ( month != 6 ) && ( month != 10 ) ) {
        register char	*p = &buf[15];
        register int	i;

        for ( i = 0; i < 16; i++, p-- )
            *( p + 2 ) = *p;
        buf[0] = ' ';
        buf[1] = ' ';
    }

    return ( buf );
}

/*
 * ‹γ―Zo—
 *	‹γ―‚Ν‚ ‚ιν‚Μ“ϊ‚π‹«–Ϊ‚Ι‚µ‚Δ‘JΪ•ϋό‚‹t“]‚·‚ι
 *	—α‚¦‚Ξ 1990”N1224“ϊ ‚ά‚Ε‚Ν ‹γ‡¨””’¨µΤ¨c¨κ”’ ‚Μ‡‚Ε‘JΪ‚·
 *	‚ι‚A 1990”N1225“ϊ ‚©‚η‚Ν κ”’¨“ρ•¨O•Ι¨c¨‹γ‡ ‚Μ‡‚Ε‘JΪ‚·
 *	‚ιB‚Ν‚Ά‚Β•Ο‚ν‚ι‚Μ‚©A•s•Χ‹­‚Μ‚½‚ί•s–Ύ‚Ε‚ ‚ιB‘JΪ•ϋό‚Μ‹t“]“ϊ‚ΜZ
 *	o‚Ν΅γ‚Μ‰Ϋ‘θ‚Ε‚ ‚ι                                  1991.02.17
 *  -----------------------------------------------------------------------
 *      —ο‚π©‚Δ‚έ‚ι‚Ζ180“ϊibq3‰ρj–‚Ι•Ο‚ν‚ι‚ζ‚¤‚Ε‚ ‚ι
 *      (‚ά‚½‚ΝA‰Δ‚ΙΕ‚ΰ‹ί‚Ά‹γ‡A“~‚ΙΕ‚ΰ‹ί‚Άκ”’‚Ε•Ο‚ν‚ι??)
 *                                                            1991.02.24
 *  -----------------------------------------------------------------------
 *  ‹γ―‚ΜZo•ϋ–@‚Ν—¬”h‚Ι‚ζ‚θA‚Ά‚λ‚Ά‚λ‚Θ‚ΰ‚Μ‚‘¶έ‚·‚ι‚±‚Ζ‚”»–ΎB
 *  ‹γ―‚Ν’†‘‚ΕlΔ‚³‚κ‚½‚ΰ‚Μ‚Ύ‚A“ϊ–{‚Ι“ό‚Α‚Δ‚­‚ι‚Ζ‚«‚ΙA“ϊ–{“Ζ©‚ΜƒAƒ
 *  ƒ“ƒW‚‰Α‚¦‚η‚κA‚³‚η‚Ι‚Ά‚λ‚Ά‚λ‚Θ—¬”h‚Ι•‚©‚κ‚½‚±‚Ζ‚΄φB
 *
 *    E—z“Ω
 *       κ”’¨“ρ•¨O•Ι¨c¨‹γ‡ ‚Μ‡Κ‚Ε‘JΪ
 *    E‰A“Ω
 *       ‹γ‡¨””’¨µΤ¨c¨κ”’ ‚Μ‡Κ‚Ε‘JΪ
 *
 *   —z“Ω‚Ζ‰A“Ω‚ΜΨ‘Φ‚¦ϊ
 *    Θ‰Ί‚Μ‚ζ‚¤‚ΙA‚Ά‚λ‚Ά‚λ‚Θ—¬”h‚‘¶έ‚·‚ι
 *     * ‰ΔA“~
 *     * “~‚ΙΕ‚ΰ‹ί‚Άbq‚Μ“ϊ‚πκ”’‚Ζ‚µ‚Δ—z“Ω‚πn‚ίA‰Δ‚Ι
 *       Ε‚ΰ‹ί‚Άbq‚Μ“ϊ‚π‹γ‡‚Ζ‚µ‚Δ‰A“Ω‚πn‚ί‚ι
 *       (“~E‰Δ‚Μ’Όγ‚Ε‚Ν‚Θ‚­A’Ό‘O‚Μκ‡‚ΰ‚ ‚θ“Ύ‚ι)
 *     * “~‚ΙΕ‚ΰ‹ί‚Άbq‚Μ“ϊ‚πκ”’‚Ζ‚µ‚Δ—z“Ω‚πn‚ίA‰Δ‚Ι
 *       Ε‚ΰ‹ί‚Άbq‚Μ“ϊ‚π‹γ‡‚Ζ‚µ‚Δ‰A“Ω‚πn‚ί‚ιB‚½‚Ύ‚µA“~
 *       E‰Δ‚Μ‘Oγ1“ϊΘ“ΰ‚Ιbί‚‚ ‚ικ‡A‚Β‚ά‚θ“~E
 *       ‰Δ‚α΅–¤EbίE‰³–Ά‚Μ‚Ά‚Γ‚κ‚©‚Ε‚ ‚ικ‡‚ΝA‚»‚Μb
 *       ί‚Μ“ϊ‚ΕΨ‚θ‘Φ‚¦‚ι‚A“~‘Oγ‚Μbί“ϊ‚ΝµΤ‚©‚ηA‰Δ
 *       ‘Oγ‚Μbί“ϊ‚ΝO•Ι‚©‚ηn‚ί‚ι(‚±‚κ‚π‰[‚Ζ‚Ά‚¤)B
 *     * “~’Όγ‚Μ‹γ‡A‰Δ’Όγ‚Μκ”’
 *     * “~’Ό‘O‚Μ‹γ‡A‰Δ’Ό‘O‚Μκ”’
 *     * ‰ΔE“~‚Ε‚Ν‚Θ‚­A¬‹E¬¦‚Ε‰A“ΩE—z“Ω‚πΨ‚θ‘Φ‚¦‚ι
 *     * 60”N‚²‚Ζ‚ΙA‰A“ΩE—z“Ω‚Μ‡‚π‹t“]‚³‚Ή‚ι(u‰Δ‹ί•Σ‚Ε—z
 *       “ΩJnA“~‹ί•Σ‚Ε‰A“ΩJnv‚Ζ‚Ά‚¤ƒpƒ^[ƒ“‚Ζu‰Δ‹ί•Σ
 *       ‚Ε‰A“ΩJnA“~‹ί•Σ‚Ε—z“ΩJnv‚Ζ‚Ά‚¤ƒpƒ^[ƒ“‚π60”N‚²
 *       ‚Ζ‚ΙΨ‘Φ‚¦‚ι)
 *     * —¬”h‚Ι‚ζ‚Α‚Δ‚Νu‰A“Ωv‚Μ‚έ‚Εu—z“Ωv‚Ν‘¶έ‚µ‚Θ‚Ά
 *     * ‚»‚Μ‘ΌA‚Ά‚λ‚Ά‚λ
 *
 *   –{ƒvƒƒOƒ‰ƒ€‚Ε‚ΝAΘ‰Ί‚ΜZo•ϋ–@‚πΜ—p‚·‚ιB
 *     —z“ΩJn: “~‚ΙΕ‚ΰ‹ί‚Άbq(κ”’)
 *     ‰A“ΩJn: —z“ΩJn“ϊ‚Μ180“ϊγ(‹γ‡)
 *
 *     [Θ‘OΜ—p‚µ‚Δ‚Ά‚½Zo•ϋ–@]
 *       —z“ΩJn: 1990”N1225“ϊ‚¨‚ζ‚ΡA‚»‚Μ360‚Μ”{”“ϊ‘OEγ
 *       ‰A“ΩJn: —z“ΩJn“ϊ‚Μ180“ϊ‘OEγ
 *         ‚±‚Μ•ϋ–@‚Ύ‚ΖA‰Δ‚β“~‚Μ“ϊ‚π‹‚ί‚ι‚±‚Ζ‚Θ‚­A‘S‚Δ‚Μ“ϊ‚Μ
 *         ‹γ―‚πZo‰Β”\‚Ε‚ ‚ι(³m‚Ι180“ϊ‚²‚Ζ‚Ι—z“ΩE‰A“Ω‚“ό‚κ‘Φ
 *         ‚ν‚ι)B‚µ‚©‚µA–”NA365 - 180 * 2 = 5“ϊ(‚ά‚½‚Ν6“ϊ)‚Γ‚Β—z
 *         “ΩJn“ϊ‚‚Έ‚κ‚Δ‚Ά‚­‚Ζ‚Ά‚¤‡“_‚‚ ‚ιB
 *
 *   Ql
 *    Yoshifumi Mori(X‰ΐj)‚Μ today ‚Ε‚ΝA
 *      “~‚Μ±x‚
 *        bq ` p’C ‚Μ‚Ζ‚«
 *          —z“ΩJn: “~‚Μ’Ό‘O‚Μκ”’‚Μ“ϊ‚©‚η
 *        •Έ\ ` α΅ε ‚Μ‚Ζ‚«
 *          —z“ΩJn: “~‚Μ’Όγ‚Μκ”’‚Μ“ϊ‚©‚η
 *        ‚»‚κΘO (α΅–¤,bί,‰³–Ά) ‚Μ‚Ζ‚«
 *          —z“ΩJn: “~‚Ι‹ί‚ΆµΤ‚Μ“ϊ‚©‚η
 *      ‰Δ‚Μ±x‚
 *        bq ` p’C ‚Μ‚Ζ‚«
 *          ‰A“ΩJn: ‰Δ‚Μ’Ό‘O‚Μ‹γ‡‚Μ“ϊ‚©‚η
 *        •Έ\ ` α΅ε ‚Μ‚Ζ‚«
 *          ‰A“ΩJn: ‰Δ‚Μ’Όγ‚Μ‹γ‡‚Μ“ϊ‚©‚η
 *        ‚»‚κΘO (α΅–¤,bί,‰³–Ά) ‚Μ‚Ζ‚«
 *          ‰A“ΩJn: ‰Δ‚Ι‹ί‚ΆO•Ι‚Μ“ϊ‚©‚η
 *    ‚Ζ‚Ά‚¤Zo•ϋ–@‚πΜ—p‚µ‚Δ‚Ά‚ιB
 *
 *      —α: 2003”N 3 6“ϊ
 *        –{ƒvƒƒOƒ‰ƒ€ [Θ‘OΜ—p‚µ‚Δ‚Ά‚½Zo•ϋ–@]
 *           ƒOƒƒSƒƒI—ο    2003”N   3(March) 6“ϊ  –Ψ—j“ϊ  Lent
 *           a—ο ‘Ύ—z—π     •½¬15”N 3(–ν¶)  6“ϊ  ‹γ‡  p  ‚Ζ‚Γ  O—Χ–S
 *                ‘Ύ‰A‘Ύ—z—ο •½¬15”N 2(”@)  4“ϊ  ‘εΐ  [ε­  ’†’
 *                ±x       α΅–Ά(‚έ‚Γ‚Μ‚Ζ‚Π‚Β‚¶)‚Μ”N •θ“Π(‚Β‚Ώ‚Μ‚¦‚Ζ‚η)‚Μ“ϊ
 *                           ¬”Ζ“y
 *
 *        –{ƒvƒƒOƒ‰ƒ€ [V‚µ‚ΆZo•ϋ–@]
 *           ƒOƒƒSƒƒI—ο    2003”N   3(March) 6“ϊ  –Ψ—j“ϊ  Lent
 *           a—ο ‘Ύ—z—π     •½¬15”N 3(–ν¶)  6“ϊ  O•Ι  p  ‚Ζ‚Γ  O—Χ–S
 *                ‘Ύ‰A‘Ύ—z—ο •½¬15”N 2(”@)  4“ϊ  ‘εΐ  [ε­  ’†’
 *                ±x       α΅–Ά(‚έ‚Γ‚Μ‚Ζ‚Π‚Β‚¶)‚Μ”N •θ“Π(‚Β‚Ώ‚Μ‚¦‚Ζ‚η)‚Μ“ϊ
 *                           ¬”Ζ“y
 *
 *        X‚Μ today
 *           2003”N 3 6“ϊ (–Ψ—j“ϊ)
 *           ‹—ο     2003”N 2 4“ϊ (‘εΐ) [’†’] 
 *           ±x     α΅–Ά (‚έ‚Έ‚Μ‚Ζ‚Π‚Β‚¶) ‚Μ”NA•θ“Π (‚Β‚Ώ‚Μ‚¦‚Ζ‚η) ‚Μ“ϊ
 *           ‹γ―     O•Ι
 *           \“ρ’Ό   •Β
 *           “ρ\”h p
 *           [ε­ O—Χ–S κ—±–”{“ϊ ¬”Ζ“y ‹Aυ“ϊ “VΝ“ϊ
 */


char	*
kyusei( j )
long	j;  /* ƒ†ƒƒEƒX“ϊ */
{
    int     hday;

#if 0
    long    change;

    /* Θ‰Ί‚ΜvZ®‚ΝA1990”N1225“ϊ‚—z“ΩJn“ϊ‚Ε‚ ‚ιA‚Ζ‚Ά‚¤–ΐ(?)‚π
       ξ‚Ι‚µ‚Δ‚Ά‚ι */
    j -= 3;
    change = ( j + 17 ) % 360;

    /* 180“ϊ‚²‚Ζ‚Ι—z“ΩE‰A“Ω‚πJ‚θ•Τ‚· */
    hday   = ( change >= 180 ) ? ( j - 1 ) % 9      /* ‰A“Ω */
                               : ( 9 - j % 9 ) % 9; /* —z“Ω */
#else
    int     yy, mm, dd;
    long    midWinterDay, kouShiDay;
    int     kanShi;

    gregorianFromAbsolute( j, &dd, &mm, &yy );
    midWinterDay = getSekkiDate( 20, 12, yy );      /* “~ */

    /* “~‚Ι‹ί‚Άbq‚Μ“ϊ */
    do {
        kanShi = ( midWinterDay + 14 ) % 60;    /* “~‚Μ±x */
        if ( kanShi < 30 ) {
            /* “~‚Ι‹ί‚Άbq‚Μ“ϊ‚ΝA“~‚ζ‚θ‘O */
            kouShiDay = midWinterDay - kanShi;
        }
        else {
            /* “~‚Ι‹ί‚Άbq‚Μ“ϊ‚ΝA“~‚ζ‚θγ */
            kouShiDay = midWinterDay + (60 - kanShi);
        }
        if ( j < kouShiDay ) {
            yy--;
            midWinterDay = getSekkiDate( 20, 12, yy );  /* 1”N‘O‚Μ“~ */
        }
    } while ( j < kouShiDay );

    hday   = (j >= kouShiDay + 180)
                ? ( j - kouShiDay + 9 ) % 9    	        /* ‰A“Ω */
                : ( 9 - ( j - kouShiDay + 1 ) % 9) % 9; /* —z“Ω */
#endif

    return ( hoshi[ hday ] );	/* ‹γ― */
}

/*
 *	±x
 *
 * bq 0 ‰³‰N 1 •Έ“Π 2 ’‰K 3 •θ’C 4 Θ–¤ 5 Mί 6 h–Ά 7 p\ 8 α΅“Ρ 9
 * bϊ10 ‰³ε11 •Έq12 ’‰N13 •θ“Π14 Θ‰K15 M’C16 h–¤17 pί18 α΅–Ά19
 * b\20 ‰³“Ρ21 •Έϊ22 ’ε23 •θq24 Θ‰N25 M“Π26 h‰K27 p’C28 α΅–¤29
 * bί30 ‰³–Ά31 •Έ\32 ’“Ρ33 •θϊ34 Θε35 Mq36 h‰N37 p“Π38 α΅‰K39
 * b’C40 ‰³–¤41 •Έί42 ’–Ά43 •θ\44 Θ“Ρ45 Mϊ46 hε47 pq48 α΅‰N49
 * b“Π50 ‰³‰K51 •Έ’C52 ’–¤53 •θί54 Θ–Ά55 M\56 h“Ρ57 pϊ58 α΅ε59
 */
char	*
eto( j, year, htmlMode )
long    j;
int     year;
int     htmlMode;
{
    int         kyear, syear, kday, sday;
    static char buf[64];

    kyear = ( year - 4 ) % 10; syear = ( year - 4 ) % 12;
    kday  = ( j + 4 ) % 10;    sday  = ( j + 2 ) % 12;

    sprintf( buf, "%s%s(%s%s)‚Μ”N%s%s%s(%s%s)‚Μ“ϊ",
             kan[kyear],       shi[syear],
             kan_yomi[kyear],  shi_yomi[syear],
             htmlMode ? "<BR>" : " ",
             kan[kday],        shi[sday],
             kan_yomi[kday],   shi_yomi[sday] );

    return ( buf );
}

void
checkEto( j, htmlMode )
long    j;
int     htmlMode;
{
    long    ks;
    int     flag = 0;

    ks = ( j + 14 ) % 60;
    if ( ( ks >= 20 ) && ( ks <= 29 ) ) { /* b\ ‚©‚η α΅–¤ */
        fputs( "  \•ϋ•ι", stdout );
        flag = 1;
    }
    if ( ks == 29 ) { /* α΅–¤ */
        fputs( "  “Vκ“Vγ", stdout );
        flag = 1;
    }
    if ( ( ks == 48 ) || ( ( ks >= 50 ) && ( ks <= 53 ) ) ||
         ( ks == 56 ) || ( ks == 57 ) || ( ks == 59 ) ) {
        /* pq, b“Π, ‰³‰K, •Έ’C, ’–¤, M\, h“Ρ, α΅ε */
        fputs( "  ”κ", stdout );
        flag = 1;
    }
    if ( ( ks >=6 ) && ( ks <= 12 ) ) {   /* Mί ‚©‚η •Έq */
        fputs( "  ‘ε”Ζ“y", stdout );
        flag = 1;
    }
    if ( ( ks >= 14 ) && ( ks <= 20 ) ) { /* •θ“Π ‚©‚η b\ */
        fputs( "  ¬”Ζ“y", stdout );
        flag = 1;
    }
    if ( flag == 0 ) {
        if ( htmlMode )
            fputs( "<BR>", stdout );
    }
}

/*
 *	µ—j
 */
char	*
weekday( g )
long	g;
{
    while ( g < 0 ) {
        g += 7;
    }

    return ( yoh[ g % 7 ] );	/* —j“ϊ */
}

/*
 *	“ω”h
 */
char	*
nijuhachishuku( g )
long	g;
{
	return ( shuku[ ( g - 4 ) % 28 ] );
}

/*
 *	\“ρ’Ό (’†’i)
 *		“ρ\lί‹C‚Μuίv‚Ζ‚»‚Μ‘O“ϊ (–{—‚Μuί•v) ‚Ε“―κ‚Μu’Όv‚π
 *		—p‚Ά‚ιΘO‚ΝA‡‚Ι‘JΪ‚µ‚Δ‚Ά‚­
 *		‚µ‚½‚‚Α‚ΔA”CΣ‚Μ“ϊ‚Μu’Όv‚π‹‚ί‚ι‚Ι‚Ν“ρ\lί‹C‚π‹‚ί‚ι•K—v
 *		‚‚ ‚ι
 *
 *	‚½‚Β	 0	‚Μ‚Ό‚­	 1	‚έ‚Β	 2	‚½‚Ά‚η	 3
 *	‚³‚Ύ‚ρ	 4	‚Ζ‚ι	 5	‚β‚Τ‚ι	 6	‚ ‚β‚Τ	 7
 *	‚Θ‚ι	 8	‚¨‚³‚ρ	 9	‚Π‚η‚­	10	‚Ζ‚Γ	11
 */

char	*
junichoku( g, dd, mm, yy, tsuki )
long    g;
int     dd, mm, yy;
int     *tsuki;
{
    static char	buf[80];
    long		g0 = 0, g2;
    int		    si, sday;

    g0 = setsuStartDay( mm, yy );	/* ί“ό‚θ‚Μ“ϊ */
    si = mm % 12;
    g2 = g0;
    do {
        sday = ( g2 + 2 ) % 12;
        g2++;
    } while ( sday != si );
    g2--;	/* g2: ί‚Ι‘Ξ‰‚·‚ιΕ‰‚Μu(‚½‚Β)v‚Μ“ϊ */
    if ( g >= g2 ) {
        strcpy( buf, choku[(g-g2)%12] );
        *tsuki = (mm - 1) % 12;
    }
    else if ( g >= g0 ) {
        strcpy( buf, choku[(12-((g2-g)%12))%12] );
        *tsuki = (mm - 1) % 12;
    }
    else {
        strcpy( buf, choku[(12-((g2-g-1)%12))%12] );
        *tsuki = (mm - 2) % 12;
    }

    return ( buf );
}


char    *
sanrinbou( g, tsuki )
long    g;
int     tsuki;
{
    char    *p = NULL;
    char    *q = "O—Χ–S";

    switch ( tsuki ) {
    case  1 : /* ‹ 1 */
    case  4 : /* ‹ 4 */
    case  7 : /* ‹ 7 */
    case 10 : /* ‹10 */
        if ( ( g + 2 ) % 12 == 11 )	/* ε */
            p = q;
        break;
    case  2 : /* ‹ 2 */
    case  5 : /* ‹ 5 */
    case  8 : /* ‹ 8 */
    case 11 : /* ‹11 */
        if ( ( g + 2 ) % 12 == 2 )	/* “Π */
            p = q;
        break;
    case  3 : /* ‹ 3 */
    case  6 : /* ‹ 6 */
    case  9 : /* ‹ 9 */
    case  0 : /* ‹12 */
        if ( ( g + 2 ) % 12 == 6 )	/* ί */
            p = q;
        break;
    }

    return( p );
}

char	*
japaneseMonthName( mm )
int	mm;
{
    return ( tsuki[(mm + 11) % 12] );
}


/* “μ–k’©‘γ‚Μa—ο•\¦ */
char	*
wareki2( d, m, y, u )
int	d, m, y, u;
{
    static char buf[48];
    int         i, j;
    int         nY = y, sY = y;

    for ( i = 0; nGengo(i); i++ ) {
        if ( nY < nGengo_start_yy(i) )
            break;
        if ( nY == nGengo_start_yy(i) ) {
            if ( m < nGengo_start_mm(i) )
                break;
            else if ( m == nGengo_start_mm(i) ) {
                if ( d < nGengo_start_dd(i) )
                    break;
            }
        }
    }
    if ( --i < 0 ) {
        i++;
        nY--;
    }
    nY -= nGengo_start_yy(i) - 1;

    for ( j = 0; sGengo(j); j++ ) {
        if ( sY < sGengo_start_yy(j) )
            break;
        if ( sY == sGengo_start_yy(j) ) {
            if ( m < sGengo_start_mm(j) )
                break;
            else if ( m == sGengo_start_mm(j) ) {
                if ( d < sGengo_start_dd(j) )
                    break;
            }
        }
    }
    if ( --j < 0 ) {
        j++;
        sY--;
    }
    sY -= sGengo_start_yy(j) - 1;

    if ( u )
	    sprintf( buf, "%s%2d”N(–k)/%s%2d”N(“μ) ‰[%2d(%s)%2d“ϊ",
                 nGengo(i), nY, sGengo(j), sY,
                 m, tsuki[(m + 11) % 12], d );
    else
	    sprintf( buf, "%s%2d”N(–k)/%s%2d”N(“μ) %2d(%s)%2d“ϊ",
                 nGengo(i), nY, sGengo(j), sY,
                 m, tsuki[(m + 11) % 12], d );
    return ( buf );
}

